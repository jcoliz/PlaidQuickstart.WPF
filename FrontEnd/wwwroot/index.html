<html>
<head>
    <title>Plaid Quickstart for WPF</title>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#link-account').click(() => { launchLink(false); });
            console.log('Loaded: OK');
        });

        // Check whether account is connected
        const getInfo = async function () {
            fetch("/api/info")
                .then(async (response) => {
                    if (response.status < 400) {
                        const info = await response.json();
                        console.log('Info: OK', JSON.stringify(info));
                        if (info.AccessToken !== null) {
                            $('#loading').hide();
                            $('#creds-item-id').text(info.ItemId);
                            $('#creds-access-token').text(info.AccessToken);
                            $('#link-done').show();
                            $('#response').text(JSON.stringify(info, null, 2));
                            console.log("GetStatus: OK")
                        }
                        else {
                            $('#loading').hide();
                            $('#link-ready').show();
                        }
                    }
                    else {
                        console.error('Info: FAILED Status', response.status);
                        $('#response').text(`LINK FAILED Status:${response.status}. Please check server logs for details.`);
                    }

                })
                .catch(reason => {
                    console.error('Info: FAILED', JSON.stringify(reason));
                });
        };

        // Grab a Link token to initialize Link
        const createLinkToken = async function (fix) {
            const res = await fetch(`/api/create_link_token?fix=${fix}`);
            const linkToken = await res.json();
            console.log('Create token: OK', JSON.stringify(linkToken));
            return linkToken;
        };

        // Initialize Link
        const launchLink = async function (fix) {
            console.debug(`Link: Launch fix=${fix}`);
            const handler = Plaid.create({
                token: await createLinkToken(fix),
                onSuccess: async (publicToken, metadata) => {
                    console.log("Link: OK", JSON.stringify(publicToken), JSON.stringify(metadata));

                    // Needs to match C# Shared.LinkResult class
                    var result = {
                        ok: true,
                        public_token: publicToken,
                        error: null,
                        metadata: metadata
                    };

                    await exchangeToken(result);
                },
                onEvent: (eventName, metadata) => {
                    console.debug("Link: Event", eventName, JSON.stringify(metadata));
                },
                onExit: (error, metadata) => {
                    console.error("Link: ERROR", JSON.stringify(error), JSON.stringify(metadata));
                },
            });
            handler.open();
        }

        // Exchange token and update info
        // Check whether account is connected
        const exchangeToken = async function (token) {
            fetch("/api/exchange_public_token", {
                method: "POST",
                body: JSON.stringify(token),
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then(async (response) => {
                    if (response.status < 400) {
                        const info = await response.json();
                        console.log('Exchange: Received', JSON.stringify(info));
                        if (info.AccessToken !== null) {
                            $('#link-done').show();
                            $('#link-ready').hide();
                            $('#loading').hide();
                            $('#creds-item-id').text(info.ItemId);
                            $('#creds-access-token').text(info.AccessToken);
                            $('#link-done').show();
                            $('#response').text(JSON.stringify(info, null, 2));
                            console.log("Exchange: OK");
                        }
                        else {
                            console.error(`Exchange: FAILED. No access token returned`);
                            $('#loading').show();
                            $('#loading').text(`LINK EXCHANGE FAILED: No access token returned. Please check server logs for details.`);
                            $('#link-ready').show();
                        }
                    }
                    else {
                        console.error('Exchange: FAILED Status', response.status);
                        $('#loading').text(`LINK EXCHANGE FAILED Status:${response.status}. Please check server logs for details.`);
                    }

                })
                .catch(reason => {
                    console.error('Exchange: FAILED', JSON.stringify(reason));
                });
        };

        getInfo();
    </script>
</head>
<body>
    <h2>Plaid Quickstart</h2>
    <div id="loading">
        Loading...
    </div>

    <div id="link-ready" style="display:none">
        <h4>
            A sample end-to-end integration with Plaid
        </h4>
        <p>
            The Plaid flow begins when your user wants to connect their bank
            account to your app. Simulate this by clicking the button below to
            launch Link - the client-side component that your users will
            interact with in order to link their accounts to Plaid and allow you
            to access their accounts via the Plaid API.
        </p>

        <div class="linkButton">
            <button type="button"
                    id="link-account"
                    style="
                        border: 1px solid black;
                        border-radius: 5px;
                        background: black;
                        height: 48px;
                        width: 155px;
                        margin-top: 5px;
                        margin-left: 10px;
                        color: white;
                        font-size: 18px;
                      ">
                <strong>Link account</strong>
            </button>
        </div>
    </div>

    <div id="link-done" style="display:none">
        <h4 class="subtitle">
            Congrats! By linking an account, you have created an <a href="http://plaid.com/docs/quickstart/glossary/#item"
                                                                    target="_blank">Item</a>.
        </h4>

        <div class="itemAccessContainer">
            <p class="itemAccessRow">
                <span class="idName">item_id</span>
                <span class="tokenText" id="creds-item-id">...</span>
            </p>

            <p class="itemAccessRow">
                <span class="idName">access_token</span>
                <span class="tokenText" id="creds-access-token">...</span>
            </p>
        </div>

        <div>
            <pre id="response"
                 style="
                    margin-left: 10px;
                    overflow-y: scroll;
                    overflow-x: hidden;
                    font-size: 14px;
                    background: #F6F6F6;
                  "></pre>
        </div>
    </div>

</body>
</html>