<html>
<head>
    <title>Plaid Quickstart for WPF</title>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script>
        // Grab a Link token to initialize Link
        const createLinkToken = async function (fix) {
            const res = await fetch(`/api/Link/CreateLinkToken?fix=${fix}`);
            const linkToken = await res.json();
            console.log('Create token: OK', JSON.stringify(linkToken));
            return linkToken;
        };

        // Initialize Link
        const launchLink = async function (fix) {
            console.debug(`Link: Launch fix=${fix}`);
            const handler = Plaid.create({
                token: await createLinkToken(fix),
                onSuccess: async (publicToken, metadata) => {
                    console.log("Link: OK", JSON.stringify(publicToken), JSON.stringify(metadata));

                    // Needs to match C# Shared.LinkResult class
                    var result = {
                        ok: true,
                        public_token: publicToken,
                        error: null,
                        metadata: metadata
                    };

                    await exchangeToken(result);
                },
                onEvent: (eventName, metadata) => {
                    console.debug("Link: Event", eventName, JSON.stringify(metadata));
                },
                onExit: (error, metadata) => {
                    console.error("Link: ERROR", JSON.stringify(error), JSON.stringify(metadata));
                    CefSharp.PostMessage(false);
                },
            });
            handler.open();
        }

        // Exchange token and update info
        // Check whether account is connected
        const exchangeToken = async function (token) {
            fetch("/api/Link/ExchangePublicToken", {
                method: "POST",
                body: JSON.stringify(token),
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then(async (response) => {
                    if (response.status < 400) {
                        const info = await response.json();
                        console.debug('Exchange: Received', JSON.stringify(info));
                        if (info.AccessToken !== null) {
                            console.log("Exchange: OK");
                            CefSharp.PostMessage(true);
                        }
                        else {
                            console.error(`Exchange: FAILED. No access token returned`);
                            CefSharp.PostMessage(false);
                        }
                    }
                    else {
                        console.error('Exchange: FAILED Status', response.status);
                        CefSharp.PostMessage(false);
                    }
                })
                .catch(reason => {
                    console.error('Exchange: FAILED', JSON.stringify(reason));
                    CefSharp.PostMessage(false);
                });
        };

        launchLink(false);
    </script>
</head>
<body>
</body>
</html>