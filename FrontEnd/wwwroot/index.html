<html>
<head>
    <title>Plaid Quickstart for WPF</title>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script>
        // Initialize Link
        const launchLink = async function () {
            console.debug(`Link: Launch`);
            const handler = Plaid.create({
                token: await linkClient.createLinkToken(),
                onSuccess: async (publicToken, metadata) => {
                    console.log("Link: OK", JSON.stringify(publicToken), JSON.stringify(metadata));

                    // Needs to match C# Shared.LinkResult class
                    var result = {
                        ok: true,
                        public_token: publicToken,
                        error: null,
                        metadata: metadata
                    };

                    await exchangeToken(result);
                },
                onEvent: (eventName, metadata) => {
                    console.debug("Link: Event", eventName, JSON.stringify(metadata));
                },
                onExit: (error, metadata) => {
                    console.error("Link: ERROR", JSON.stringify(error), JSON.stringify(metadata));
                    CefSharp.PostMessage(false);
                },
            });
            handler.open();
        }

        // Exchange token and update info
        // Check whether account is connected
        const exchangeToken = async function (token) {
            linkClient.exchangePublicToken(token)
                .then(info => {
                    console.debug('Exchange: Received', JSON.stringify(info));
                    console.log("Exchange: OK");
                    CefSharp.PostMessage(true);
                })
                .catch(reason => {
                    console.error('Exchange: FAILED', JSON.stringify(reason));
                    CefSharp.PostMessage(false);
                });
        };

        launchLink();
    </script>
</head>
<body>
</body>
</html>